<!DOCTYPE html>
<html lang="es">
<head>
    <title>OpenLayers.Editor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">



    <script src="../lib/OpenLayers.js"></script>
    <script type="text/javascript" src="../lib/loader.js"></script>
    <script type="text/javascript" src="../jquery/jquery.js"></script>
    <script type="text/javascript" src="../bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../bootstrap/js/bootstrap-filestyle.min.js"></script>
    <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../bootstrap/css/bootstrap-theme.min.css" type="text/css" />

    <link rel="stylesheet" href="../colorpicker/dist/css/bootstrap-colorpicker.min.css" type="text/css" />
    <script type="text/javascript" src="../colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
    <link rel="stylesheet" href="../bootstrap-slider/dist/css/bootstrap-slider.min.css" type="text/css" />
    <script type="text/javascript" src="../bootstrap-slider/dist/bootstrap-slider.min.js"></script>

    <script type="text/javascript">
        var URL_SERVER = 'http://localhost:8080';
        var layerAttributes = new Map();
        var layerStyles = new Map();
		var map, editor;
        function init() {
            OpenLayers.Lang.setCode(language);
            map = new OpenLayers.Map('map');
           // map.addLayer(new OpenLayers.Layer.OSM());
            //async
            var baseLayerData = null;
            var BaseLayerRequest = new OpenLayers.Request.GET({
                url: URL_SERVER + '/gis-persistent/rest/layer/baseLayer',
                async: false,
                callback: function (response) {
                     var obj = JSON.parse(response.responseText);
                    baseLayerData = obj.data;
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });

			//console.log("after base layer");
			var baseLayer = new OpenLayers.Layer.Vector("Mapa Oruro", {
									projection       : "EPSG:4326",
                                    isBaseLayer      : true,
									strategies       : [new OpenLayers.Strategy.Fixed()],
									protocol         :  new OpenLayers.Protocol.HTTP({
                                                            url: URL_SERVER + '/gis-persistent/rest/layer/' + baseLayerData.layerId + '/listGeometries',
															format: new OpenLayers.Format.GeoJSON()
														}),
                                    styleMap: new OpenLayers.StyleMap({'default':{
                                                    strokeColor: "#00FF00",
                                                    strokeOpacity: 1,
                                                    strokeWidth: 2,
                                                    fillColor: "blue",
                                                    fillOpacity: 0.5,
                                                    pointRadius: 6,
                                                    pointerEvents: "visiblePainted",
                                                    // label with \n linebreaks
                                                    label : "${NAME_2}",

                                                    fontColor: "red",
                                                    fontSize: "11px",
                                                    fontFamily: "Courier New, monospace",
                                                    fontWeight: "bold",
                                                    labelAlign: "${align}",
                                                    labelXOffset: "${xOffset}",
                                                    labelYOffset: "${yOffset}",
                                                    labelOutlineColor: "white",
                                                    labelOutlineWidth: 2
                                    }})
								});
            baseLayer.id = baseLayerData.layerId;
			map.addLayer(baseLayer);
            map.addControl(new OpenLayers.Control.MousePosition());
            map.addControl(new OpenLayers.Control.ScaleLine());
            map.addControl(new OpenLayers.Control.LayerSwitcher());
            //map.addControl(new OpenLayers.Control.KeyboardDefaults());
            //map.addControl(new OpenLayers.Control.OverviewMap());

            map.setCenter(new OpenLayers.LonLat(-67.79266, -18.70219), 8);


            editor = new OpenLayers.Editor(map, {
                activeControls: [
                      'LayerSettings'
                    , 'Navigation'
                    , 'SnappingSettings'
                    , 'CADTools'
                    , 'TransformFeature'
                    , 'Separator'
                    , 'DeleteFeature'
                    , 'DragFeature'
                    , 'SelectFeature'
                    , 'Separator'
                    , 'DrawHole'
                    , 'ModifyFeature'
                    , 'Separator'
                ],
                featureTypes: ['text','regular', 'polygon', 'path', 'point']
            });
            //editor.startEditMode();
            loadLayerList();
        }



        function uploadShape() {
            var formData = new FormData();
            formData.append("files", document.getElementById("shp").files[0]);
            formData.append("files", document.getElementById("dbf").files[0]);
            formData.append("files", document.getElementById("shx").files[0]);
            formData.append("files", document.getElementById("prj").files[0]);
            var request = new OpenLayers.Request.POST({
				url: URL_SERVER + '/gis-persistent/rest/file/temp/upload',
                data: formData,
                callback: function (response) {
                    var geoJsonResponse = JSON.parse(response.responseText);
                    var layer = new OpenLayers.Layer.Vector("GeoJSON", {
                        displayInLayerSwitcher: false
                    });

                    var requestObj = {
                        layerName: geoJsonResponse.name,
                        epsgCode: 4326
                    };

                    OpenLayers.Request.POST({
                        url: URL_SERVER + '/gis-persistent/rest/layer/save',
                        data: JSON.stringify(requestObj),
                        headers: {
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        dataType: 'json',
                        callback: function (response) {
                            var obj = JSON.parse(response.responseText);
                            if(!obj.success) return;
                            var layerData = obj.data;

                            var geojson = new OpenLayers.Format.GeoJSON();
                            var layer = new OpenLayers.Layer.Vector("GeoJSON", {
                                displayInLayerSwitcher: false
                            });
                            layer.id = layerData.layerId;
                            layer.addFeatures(geojson.read(geoJsonResponse.data));
                            map.addLayer(layer);

                            var set = new Set();
                            for(var i = 0; i < layer.features.length; i++) {
                                for(var prop in layer.features[i].attributes) {
                                    set.add(prop);
                                }
                                for(var prop in layer.features[i].data) {
                                    set.add(prop);
                                }
                            }
                            var attrs = []
                            set.forEach(function (e) {
                                attrs.push({
                                attributeId: null,
                                attributeName: e,
                                attributeType: 'String'
                                });
                            });
                            layerAttributes.set(layerData.layerId, attrs);

                            var htmlStr = getLayerView(layerData);
                            $('#layerList').append(htmlStr);
                        },
                        failure: function (response) {
                            console.log("Failure: ");
                        }
                    });
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function loadLayerList() {
            var request = new OpenLayers.Request.GET({
                url:  URL_SERVER + '/gis-persistent/rest/layer/listAll',
                callback: function (response) {
                    var json = JSON.parse(response.responseText);
                    if(!json.success) {
                        alert('Error!!');
                        return;
                    }
                    var layerList = json.list;
                    var htmlStr = "";
                    layerList.forEach(function(e) {
                        htmlStr += getLayerView(e);
                        var layer = new OpenLayers.Layer.Vector("GeoJSON", {
                            displayInLayerSwitcher: false,
                            strategies: [new OpenLayers.Strategy.Fixed()],
                            protocol: new OpenLayers.Protocol.HTTP({
                                url: URL_SERVER + '/gis-persistent/rest/layer/' + e.layerId + '/listGeometries',
                                format: new OpenLayers.Format.GeoJSON()
                            })
                        });

                        OpenLayers.Request.GET({
                            url: URL_SERVER + '/gis-persistent/rest/style/layer/' + e.layerId + '/sld',
                            success: function(response) {
                                var format = new OpenLayers.Format.SLD();
                                var sld = format.read(response.responseXML || response.responseText);
                                layer.styleMap.styles["default"] = sld.namedLayers["style-template"].userStyles[0];//use 0 if there's only one user styles

                                var styleRules = layer.styleMap.styles.default.rules;
                                for(var i = 0; i < styleRules.length; i++) {
                                    if(!styleRules[i].filter)
                                        continue;
                                    var symbolizer = styleRules[i].symbolizer;
                                    if(symbolizer.Point && symbolizer.Text) {
                                        for(var p in symbolizer.Text) {
                                            if(p == 'label') {
                                                var labels = symbolizer.Text[p].match(/(\$\{)([^}]+)(\})/)[2].split(',');
                                                var str = '\n';
                                                for(var k = 0; k < labels.length; k++)
                                                    str += '${' + labels[k] + '}' + '\n';
                                                symbolizer.Point[p] = str;
                                            }else
                                                symbolizer.Point[p] = symbolizer.Text[p];
                                        }
                                    }
                                    if(symbolizer.Line && symbolizer.Text) {
                                        for(var p in symbolizer.Text) {
                                            if(p == 'label') {
                                                var labels = symbolizer.Text[p].match(/(\$\{)([^}]+)(\})/)[2].split(',');
                                                var str = '\n';
                                                for(var k = 0; k < labels.length; k++)
                                                    str += '${' + labels[k] + '}' + '\n';
                                                symbolizer.Line[p] = str;
                                            }else
                                                symbolizer.Line[p] = symbolizer.Text[p];
                                        }
                                    }
                                    if(symbolizer.LineString && symbolizer.Text) {
                                        for(var p in symbolizer.Text) {
                                            if(p == 'label') {
                                                var labels = symbolizer.Text[p].match(/(\$\{)([^}]+)(\})/)[2].split(',');
                                                var str = '\n';
                                                for(var k = 0; k < labels.length; k++)
                                                    str += '${' + labels[k] + '}' + '\n';
                                                symbolizer.LineString[p] = str;
                                            }else
                                                symbolizer.LineString[p] = symbolizer.Text[p];
                                        }
                                    }
                                    if(symbolizer.Polygon && symbolizer.Text) {
                                        for(var p in symbolizer.Text) {
                                            if(p == 'label') {
                                                var labels = symbolizer.Text[p].match(/(\$\{)([^}]+)(\})/)[2].split(',');
                                                var str = '\n';
                                                for(var k = 0; k < labels.length; k++)
                                                    str += '${' + labels[k] + '}' + '\n';
                                                symbolizer.Polygon[p] = str;
                                            }else
                                                symbolizer.Polygon[p] = symbolizer.Text[p];
                                        }
                                    }
                                }
                            }
                        });

                        layer.id = e.layerId;
                        map.addLayer(layer);
                    });
                    $('#layerList').html(htmlStr);
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function addLayerToEditor(layerId) {
            if(editor){
                editor.stopEditMode();
            }
            var layer = map.getLayer(layerId);
            if(!layer) {
                layer = new OpenLayers.Layer.Vector("GeoJSON", {
                    displayInLayerSwitcher: false
                });
                layer.id = layerId;
                map.addLayer(layer);
            }

            editor.editLayer = layer;
            //editor.stopEditMode();
            //editor.initialize(map, {editLayer: layer});
            //console.log(layer);
            editor.addEditorControls();
            editor.startEditMode();
            console.log(layer);
        }

        function setVisibility(layerId, state) {
            var layer = map.getLayer(layerId);
            if(layer)
                layer.setVisibility(state);
            else {
                layer = new OpenLayers.Layer.Vector("GeoJSON", {
                    displayInLayerSwitcher: false,
                    strategies: [new OpenLayers.Strategy.Fixed()],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: URL_SERVER + '/gis-persistent/rest/layer/' + layerId + '/listGeometries',
                        format: new OpenLayers.Format.GeoJSON()
                    })
                });
                layer.id = layerId;
                map.addLayer(layer);
            }
        }

        function saveGeometry(layerId) {
            var layer = map.getLayer(layerId);
            if(!layer.features.length){
                console.log('empty features');
                return
            }
            var listAttribs = layerAttributes.get(layerId) || [];
            for(var k = 0; k < listAttribs.length; k++) {
                var attribName = listAttribs[k].attributeName;
                for (var i = 0; i < layer.features.length; i++) {
                    if (!layer.features[i].attributes[attribName])
                        layer.features[i].attributes[attribName] = null;
                    if (!layer.features[i].data[attribName])
                        layer.features[i].data[attribName] = null;
                }
            }
            var formatJson = new OpenLayers.Format.GeoJSON();
            var geojson = JSON.parse(formatJson.write(layer.features));
            var layerRequest = {
                attributes: listAttribs,
                geojson: geojson
            };

            var request = new OpenLayers.Request.POST({
                url: URL_SERVER + '/gis-persistent/rest/layer/' + layerId + '/saveGeometries',
                data: JSON.stringify(layerRequest),
                dataType: 'json',
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                callback: function (response) {
                    console.log(response);
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });

        }
        function addNewLayer() {
            $('#layerModal').modal('show');
        }
        function saveLayer() {
            var layerName = $('#layerModal input').val();
            var obj = {
                layerName: layerName,
                epsgCode: 4326
            };
            var request = new OpenLayers.Request.POST({
                url: URL_SERVER + '/gis-persistent/rest/layer/save',
                data: JSON.stringify(obj),
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                dataType: 'json',
                callback: function (response) {
                    $('#layerModal').modal('hide');
                    $('#layerModal input').val('');
                    var obj = JSON.parse(response.responseText);
                    if(!obj.success) return;
                    var layerData = obj.data;

                    var layer = new OpenLayers.Layer.Vector("GeoJSON", {
                        displayInLayerSwitcher: false
                    });
                    layer.id = layerData.layerId;
                    map.addLayer(layer);
                    var htmlStr = getLayerView(layerData);
                    $('#layerList').append(htmlStr);
                },
                failure: function (response) {
                    $('#layerModal').modal('hide');
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }
        function deleteStyle(layerId) {
            OpenLayers.Request.POST({
                url: URL_SERVER + '/gis-persistent/rest/layer/' + layerId + '/delete',
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                callback: function (response) {
                    if(map.getLayer(layerId))
                        map.getLayer(layerId).destroy();
                    $("#layerList tr[data-layer-id = '" + layerId + "']").remove();
                    console.log(response);
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function showAttributes(layerId) {
            var layer = map.getLayer(layerId);
            var listAttribs = layerAttributes.get(layerId);
            if(layer && isNaN(layerId)) {
                var set = new Set();
                for(var i = 0; i < layer.features.length; i++) {
                    for(var prop in layer.features[i].attributes) {
                        set.add(prop);
                    }
                    for(var prop in layer.features[i].data) {
                        set.add(prop);
                    }
                }
                var attrs = []
                set.forEach(function (e) {
                    attrs.push({
                        attributeId: null,
                        attributeName: e,
                        attributeType: 'String'
                    });
                });
                layerAttributes.set(layerId, attrs);
                listAttribs = attrs;
            }
            if(!listAttribs) {
                var request = new OpenLayers.Request.GET({
                    url: URL_SERVER + '/gis-persistent/rest/layer/' + layerId + '/listAttributes',
                    callback: function (response) {
                        var obj = JSON.parse(response.responseText);
                        if (!obj.success) return;
                        layerAttributes.set(layerId, obj.list);
                        renderAttributes(layerId)
                    },
                    failure: function (response) {
                        console.log("Failure: ");
                        console.log(response);
                    }
                });
            }
            else {
                renderAttributes(layerId);
            }
        }

        function addNewAttribute(layerId) {
            var layer = map.getLayer(layerId);
            var attribName = $("#attributeListModal input[name = 'attributeName']").val();
            if(!attribName)
                return;
            var attributeType = $("#attributeListModal input[name = 'attributeType']:checked").attr('type-date');
            var listAttribs = layerAttributes.get(layerId);
            if(!listAttribs) {
                layerAttributes.set(layerId, [{attributeId: null, attributeName: attribName, attributeType: attributeType}]);
            }else{
                for(var i = 0; i < listAttribs.length; i++) {
                    var e = listAttribs[i];
                    if(e.attributeName === attribName) return;
                }
                listAttribs.push({attributeId: null, attributeName: attribName, attributeType: attributeType});
            }
            if(layer) {
                for(var i = 0; i < layer.features.length; i++) {
                    layer.features[i].attributes[attribName] = null;
                    layer.features[i].data[attribName] = null;
                }

            }
            renderAttributes(layerId);
        }

        function onChangeAttribute(comp, layerId, i, attributeName, attributeType) {
            var value = comp.textContent;
            var layer = map.getLayer(layerId);
            if(attributeType === 'Integer') {
                if(isNaN(value)) {
                    alert('Invalido!!');
                }else {
                    value = parseInt(value);
                }
            }else if( attributeType === 'Double') {
                if(isNaN(value)) {
                    alert('Invalido!!');
                }else {
                    value = parseFloat(value);
                }
            }

            if(layer) {
                layer.features[i].attributes[attributeName] = value;
                layer.features[i].data[attributeName] = value;
            }
        }

        function renderAttributes(layerId) {
            var layer = map.getLayer(layerId);
            var attribList = layerAttributes.get(layerId);
            if(layer == null || attribList == null) return;
            var htmlNewAttr  = "<div class=\"input-group\">";
            htmlNewAttr += "<span class=\"input-group-addon\">Nombre Attributo</span>";
            htmlNewAttr += "<input type=\"text\" name=\"attributeName\" class=\"form-control\" aria-label=\"...\">";
            htmlNewAttr += "<span class=\"input-group-addon\">String <input type=\"radio\" checked type-date=\"String\" name=\"attributeType\" aria-label=\"...\"></span>";
            htmlNewAttr += "<span class=\"input-group-addon\">Integer <input type=\"radio\" type-date=\"Integer\" name=\"attributeType\" aria-label=\"...\"></span>";
            htmlNewAttr += "<span class=\"input-group-addon\">Float <input type=\"radio\" type-date=\"Double\" name=\"attributeType\" aria-label=\"...\"></span>";
            htmlNewAttr += "<span class=\"input-group-btn\">";
            htmlNewAttr += "<button type=\"button\" class=\"btn btn-default btn-md\" onclick=\"addNewAttribute(" + layerId + ")\">";
            htmlNewAttr += "<span class=\"glyphicon glyphicon-plus\" aria-hidden=\"true\"></span> Agregar";
            htmlNewAttr += "</button>";
            htmlNewAttr += "</span>";
            htmlNewAttr += "</div>";

            var htmlHead = "<table class=\"table table-bordered\"><thead><tr>";
            htmlHead += "<th>#</th>";
            for(var k = 0; k < attribList.length; k++) {
                var attribType = (attribList[k].attributeType == 'Integer')?'Int': (attribList[k].attributeType == 'Double')?'Float':'Str';
                htmlHead += "<th>" + attribList[k].attributeName + "["+ attribType +"]</th>";
            }
            htmlHead += "</tr></thead>";
            var htmlBody = "<tbody>";

            for(var i = 0; i < layer.features.length; i++) {
                htmlBody += "<tr>";
                htmlBody += "<td>" + (i + 1) + "</td>";
                for(var k = 0; k < attribList.length; k++) {
                    var attribValue = layer.features[i].attributes['' + attribList[k].attributeName];
                    if(attribValue == null || attribValue === 'undefined')
                        attribValue = '';
                    htmlBody += "<td oninput = \"onChangeAttribute(this," + layerId + "," + i + ",'" + attribList[k].attributeName +"', '"+ attribList[k].attributeType +"')\"  contenteditable=\"true\">" + attribValue + "</td>";
                }
                htmlBody += "</tr>";
            }
            htmlBody += "</tbody></table>";
            $('#attributeListModal .modal-body').html(htmlNewAttr + htmlHead + htmlBody);
            $('#attributeListModal').modal('show');
        }

        function getLayerView(e) {
            var htmlStr = "<tr data-layer-id = '"+ e.layerId +"'>";
                htmlStr += "<td>" + e.layerName + "</td>";
                htmlStr += "<td><input type=\"checkbox\" checked onchange = \"setVisibility(" + e.layerId +", this.checked)\"></td>";
                htmlStr += "<td><input type=\"radio\" name=\"editable\" onchange =\"addLayerToEditor(" + e.layerId + ")\"></td>";
                htmlStr += "<td>";
                htmlStr += "<div class=\"btn-group button-bar\" role=\"group\" aria-label=\"...\">";
                htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\"  onclick = \"showAttributes(" + e.layerId + ")\"  data-toggle=\"tooltip\" title=\"Atributos\">";
                htmlStr += "<span class=\"glyphicon glyphicon-eye-open\" aria-hidden=\"true\"></span>";
                htmlStr += "</button>";
                htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\"  onclick = \"saveGeometry(" + e.layerId + ")\"  data-toggle=\"tooltip\" title=\"Guardar Geometria\">";
                htmlStr += "<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span>";
                htmlStr += "</button>";
                htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\" onclick = \"showStyle(" + e.layerId + ")\" data-toggle=\"tooltip\" title=\"Estilos\">";
                htmlStr += "<span class=\"glyphicon glyphicon-picture\" aria-hidden=\"true\"></span>";
                htmlStr += "</button>";
                htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\" onclick = \"deleteStyle(" + e.layerId + ")\" data-toggle=\"tooltip\" title=\"Eliminar\">";
                htmlStr += "<span class=\"glyphicon glyphicon-trash\" aria-hidden=\"true\"></span>";
                htmlStr += "</button>";
                htmlStr += "</div>";
                htmlStr += "</td>";
                htmlStr += "</tr>";
            return htmlStr;
        }

        var pointOpacityFill = null;
        var pointStrokeOpacity = null;
        var lineOpacityFill = null;
        var lineStrokeOpacity = null;
        var polygonOpacityFill = null;
        var polygonStrokeOpacity = null;

        var pointColorFillPicker = null;
        var pointStrokeColorPicker = null;
        var lineColorFillPicker = null;
        var lineStrokeColorPicker = null;
        var polygonColorFillPicker = null;
        var polygonStrokeColorPicker = null;
        $(function() {
            pointColorFillPicker = $('#point-color-fill-picker').colorpicker({format: 'hex'});
            pointStrokeColorPicker = $('#point-stroke-color-picker').colorpicker({format: 'hex'});
            lineColorFillPicker = $('#line-color-fill-picker').colorpicker({format: 'hex'});
            lineStrokeColorPicker = $('#line-stroke-color-picker').colorpicker({format: 'hex'});
            polygonColorFillPicker = $('#polygon-color-fill-picker').colorpicker({format: 'hex'});
            polygonStrokeColorPicker = $('#polygon-stroke-color-picker').colorpicker({format: 'hex'});

            pointOpacityFill = $('#point-opacity-fill').slider({formatter: function(value) {return value;}});
            pointStrokeOpacity = $('#point-stroke-opacity').slider({formatter: function(value) {return value;}});
            lineOpacityFill  = $('#line-opacity-fill').slider({formatter: function(value) {return value;}});
            lineStrokeOpacity = $('#line-stroke-opacity').slider({formatter: function(value) {return value;}});
            polygonOpacityFill = $('#polygon-opacity-fill').slider({formatter: function(value) {return value;}});
            polygonStrokeOpacity = $('#polygon-stroke-opacity').slider({formatter: function(value) {return value;}});
        });


        function showStyle(layerId) {
            var layer = map.getLayer(layerId);
            var styleRules = layer.styleMap.styles.default.rules;
            for(var i = 0; i < styleRules.length; i++) {
                if(!styleRules[i].filter)
                    continue;
                var symbolizer = styleRules[i].symbolizer;
                if(symbolizer.Point) {
                    pointColorFillPicker.colorpicker('setValue', symbolizer.Point.fillColor);
                    pointOpacityFill.slider('setValue', symbolizer.Point.fillOpacity);
                    pointStrokeColorPicker.colorpicker('setValue', symbolizer.Point.strokeColor);
                    $('#point-stroke-with').val(symbolizer.Point.strokeWidth);
                    pointStrokeOpacity.slider('setValue', symbolizer.Point.strokeOpacity);
                }
                if(symbolizer.Line) {
                    //lineColorFillPicker.colorpicker('setValue', symbolizer.Line.fillColor);
                    //lineOpacityFill.slider('setValue', symbolizer.Line.fillOpacity);
                    lineStrokeColorPicker.colorpicker('setValue', symbolizer.Line.strokeColor);
                    $('#line-stroke-with').val(symbolizer.Line.strokeWidth);
                    lineStrokeOpacity.slider('setValue', symbolizer.Line.strokeOpacity);
                }

                if(symbolizer.Polygon) {
                    polygonColorFillPicker.colorpicker('setValue', symbolizer.Polygon.fillColor);
                    polygonOpacityFill.slider('setValue', symbolizer.Polygon.fillOpacity);
                    polygonStrokeColorPicker.colorpicker('setValue', symbolizer.Polygon.strokeColor);
                    $('#polygon-stroke-with').val(symbolizer.Polygon.strokeWidth);
                    polygonStrokeOpacity.slider('setValue', symbolizer.Polygon.strokeOpacity);
                }
            }
            var m = $('#styleModal').modal('show');
            m.attr('data-layer-id', layerId);
        }

        function applyStyle() {
            var m = $('#styleModal');
            var layerId = m.attr('data-layer-id');
            var localPointColorFill = $('#point-color-fill').val();
            var localPointOpacityFill = pointOpacityFill.slider('getValue')
            var localPointStrokeColor = $('#point-stroke-color').val();
            var localPointStrokeWith = $('#point-stroke-with').val();
            var localPointStrokeOpacity = pointStrokeOpacity.slider('getValue')

            var localLineColorFill = $('#line-color-fill').val();
            var localLineOpacityFill = lineOpacityFill.slider('getValue')
            var localLineStrokeColor = $('#line-stroke-color').val();
            var localLineStrokeWith = $('#line-stroke-with').val();
            var localLineStrokeOpacity = lineStrokeOpacity.slider('getValue')

            var localPolygonColorFill = $('#polygon-color-fill').val();
            var localPolygonOpacityFill = polygonOpacityFill.slider('getValue')
            var localPolygonStrokeColor = $('#polygon-stroke-color').val();
            var localPolygonStrokeWith = $('#polygon-stroke-with').val();
            var localPolygonStrokeOpacity = polygonStrokeOpacity.slider('getValue')

            var layer = map.getLayer(layerId);
            var styleRules = layer.styleMap.styles.default.rules;
            for(var i = 0; i < styleRules.length; i++) {
                if(!styleRules[i].filter)
                        continue;
                var symbolizer = styleRules[i].symbolizer;
                if(symbolizer.Point) {
                    symbolizer.Point.stroke = true;
                    symbolizer.Point.fillColor = localPointColorFill;
                    symbolizer.Point.fillOpacity = localPointOpacityFill;
                    symbolizer.Point.strokeColor = localPointStrokeColor;
                    symbolizer.Point.strokeWidth = parseInt(localPointStrokeWith);
                    symbolizer.Point.strokeOpacity = localPointStrokeOpacity;
                    var pointStyle = {
                        "fill" : localPointColorFill,
                        "fill-opacity" : localPointOpacityFill,
                        "stroke" : localPointStrokeColor,
                        "stroke-width" : parseInt(localPointStrokeWith),
                        "stroke-opacity" : localPointStrokeOpacity
                    };

                    OpenLayers.Request.POST({
                        url: URL_SERVER + '/gis-persistent/rest/style/layer/' + layerId + '/geometryType/Point/save',
                        data: JSON.stringify(pointStyle),
                        dataType: 'json',
                        headers: {
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        callback: function (response) {
                            console.log(response);
                        },
                        failure: function (response) {
                            console.log("Failure: ");
                            console.log(response);
                        }
                    });

                }

                if(symbolizer.Line) {
                    symbolizer.Line.strokeColor = localLineStrokeColor;
                    symbolizer.Line.strokeWidth = parseInt(localLineStrokeWith);
                    symbolizer.Line.strokeOpacity = localLineStrokeOpacity;

                    var lineStyle = {
                        "stroke" : localLineStrokeColor,
                        "stroke-width" : parseInt(localLineStrokeWith),
                        "stroke-opacity" : localLineStrokeOpacity
                    };

                    OpenLayers.Request.POST({
                        url: URL_SERVER + '/gis-persistent/rest/style/layer/' + layerId + '/geometryType/Line/save',
                        data: JSON.stringify(lineStyle),
                        dataType: 'json',
                        headers: {
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        callback: function (response) {
                            console.log(response);
                        },
                        failure: function (response) {
                            console.log("Failure: ");
                            console.log(response);
                        }
                    });
                }

                if(symbolizer.Polygon) {
                    symbolizer.Polygon.stroke = true;
                    symbolizer.Polygon.fillColor = localPolygonColorFill;
                    symbolizer.Polygon.fillOpacity = localPolygonOpacityFill;
                    symbolizer.Polygon.strokeColor = localPolygonStrokeColor;
                    symbolizer.Polygon.strokeWidth = parseInt(localPolygonStrokeWith);
                    symbolizer.Polygon.strokeOpacity = localPolygonStrokeOpacity;

                    var polygonStyle = {
                        "fill" : localPolygonColorFill,
                        "fill-opacity" : localPolygonOpacityFill,
                        "stroke" : localPolygonStrokeColor,
                        "stroke-width" : parseInt(localPolygonStrokeWith),
                        "stroke-opacity" : localPolygonStrokeOpacity
                    };

                    OpenLayers.Request.POST({
                        url: URL_SERVER + '/gis-persistent/rest/style/layer/' + layerId + '/geometryType/Polygon/save',
                        data: JSON.stringify(polygonStyle),
                        dataType: 'json',
                        headers: {
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        callback: function (response) {
                            console.log(response);
                        },
                        failure: function (response) {
                            console.log("Failure: ");
                            console.log(response);
                        }
                    });
                }
            }



            layer.redraw();
            $('#styleModal').modal('hide');

        }


    </script>
    <style type="text/css">
    /* Make map consume all available space */
    #map {
        height: 600px;
        min-height: 600px;
        /*background-color: #2aabd2; */
    }
    /*
    .modal-dialog {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    */
    .modal-content {
        height: auto;
        min-height: 100%;
        border-radius: 0;
    }
    .button-bar {
        min-width: 133px;
    }
    </style>
    <link rel="stylesheet" href="../theme/geosilk/geosilk.css" type="text/css" />
</head>
<body onload="init()">

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 panel panel-default">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#sectionA">Section A</a></li>
                <li><a data-toggle="tab" href="#sectionB">Section B</a></li>
                <li><a data-toggle="tab" href="#sectionC">Section C</a></li>
            </ul>
            <div class="tab-content">
                <div id="sectionA" class="tab-pane active table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Capas</th>
                                <th><div data-toggle="tooltip" title="Visible"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span></div></th>
                                <th><div data-toggle="tooltip" title="Editable"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></div></th>
                                <th>Opciones</th>
                            </tr>
                        </thead>
                        <tbody id = "layerList"></tbody>
                    </table>
                    <button type="button" class="btn btn-default btn-sm" onclick="addNewLayer()">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Nueva Capa
                    </button>
                </div>
                <div id="sectionB" class="tab-pane fade table-responsive">
                    seccion B
                </div>
                <div id="sectionC" class="tab-pane fade">
                    <h3>Formato Shape File</h3>
                    <form id = "fileForm" method="post" action="" enctype="multipart/form-data">
                        <input id="shp" type="file" accept=".shp" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="dbf" type="file" accept=".dbf" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="shx" type="file" accept=".shx" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="prj" type="file" accept=".prj" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                    </form>
                    <button onclick = "uploadShape()" class="btn btn-default">Subir</button>
                </div>
            </div>
        </div>

        <div class="col-sm-9 panel panel-default">
            <div id="map"></div>
        </div>
    </div>



    <div id="layerModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Nueva Capa</h4>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon" id="basic-addon1">Nombre o Desc.</span>
                        <input type="text" class="form-control" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLayer()">Guardar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div id="attributeListModal" class="modal fade" tabindex="-1" role="dialog" data-layer-id = "0">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Atributos</h4>
                </div>
                <div class="modal-body table-responsive">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


    <div id="styleModal" class="modal fade" tabindex="-1" role="dialog" data-layer-id = "0">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body table-responsive">
                       <ul class="nav nav-tabs">
                           <li class="active"><a data-toggle="tab" href="#sectionPoint">Punto</a></li>
                           <li><a data-toggle="tab" href="#sectionLine">Linea</a></li>
                           <li><a data-toggle="tab" href="#sectionPolygon">Poligono</a></li>
                       </ul>
                       <div class="tab-content">
                           <div id="sectionPoint" class="tab-pane active">
                               <h4>Relleno</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-color-fill" class="col-xs-3 control-label">Color: </label>
                                               <div id="point-color-fill-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="point-color-fill" type="text" value="#00AABB" class="form-control" />
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-opacity-fill" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="point-opacity-fill" class="form-control" data-slider-id='point-opacity-fill' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                               <h4>Stroke</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-stroke-style" class="col-xs-3 control-label">Estilo: </label>
                                               <div id="cp4" class="col-xs-9 input-group colorpicker-component">
                                                   <select id="point-stroke-style" class="form-control input-sm">
                                                       <option>
                                                           <h5>holas estylo</h5>
                                                       </option>
                                                       <option>2</option>
                                                       <option>3</option>
                                                   </select>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-stroke-color" class="col-xs-3 control-label">Color: </label>
                                               <div id="point-stroke-color-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="point-stroke-color" type="text" value="#00AABB" class="form-control" aria-describedby="sizing-addon3"/>
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-stroke-with" class="col-xs-3 control-label">Ancho: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="point-stroke-with" type="text" value="1" class="form-control" aria-describedby="sizing-addon3"/>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="point-stroke-opacity" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="point-stroke-opacity" class="form-control" data-slider-id='point-stroke-opacity' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>



                           <div id="sectionLine" class="tab-pane">
                               <h4>Relleno</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-color-fill" class="col-xs-3 control-label">Color: </label>
                                               <div id="line-color-fill-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="line-color-fill" type="text" value="#43A3434" class="form-control" />
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-opacity-fill" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="line-opacity-fill" class="form-control" data-slider-id='line-opacity-fill' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                               <h4>Stroke</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-stroke-style" class="col-xs-3 control-label">Estilo: </label>
                                               <div id="cp1" class="col-xs-9 input-group colorpicker-component">
                                                   <select id="line-stroke-style" class="form-control input-sm">
                                                       <option>
                                                           <h5>holas estylo</h5>
                                                       </option>
                                                       <option>2</option>
                                                       <option>3</option>
                                                   </select>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-stroke-color" class="col-xs-3 control-label">Color: </label>
                                               <div id="line-stroke-color-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="line-stroke-color" type="text" value="#00AABB" class="form-control" aria-describedby="sizing-addon3"/>
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-stroke-with" class="col-xs-3 control-label">Ancho: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="line-stroke-with" type="text" value="1" class="form-control" aria-describedby="sizing-addon3"/>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="line-stroke-opacity" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="line-stroke-opacity" class="form-control" data-slider-id='line-stroke-opacity' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>


                           <div id="sectionPolygon" class="tab-pane">
                               <h4>Relleno</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-color-fill" class="col-xs-3 control-label">Color: </label>
                                               <div id="polygon-color-fill-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="polygon-color-fill" type="text" value="#000000" class="form-control" />
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-opacity-fill" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="polygon-opacity-fill" class="form-control" data-slider-id='polygon-opacity-fill' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                               <h4>Stroke</h4>
                               <div class="panel panel-default">
                                   <div class="panel-body">
                                       <div class="row form-horizontal">
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-stroke-style" class="col-xs-3 control-label">Estilo: </label>
                                               <div id="cp2" class="col-xs-9 input-group colorpicker-component">
                                                   <select id="polygon-stroke-style" class="form-control input-sm">
                                                       <option>
                                                           <h5>holas estylo</h5>
                                                       </option>
                                                       <option>2</option>
                                                       <option>3</option>
                                                   </select>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-stroke-color" class="col-xs-3 control-label">Color: </label>
                                               <div id="polygon-stroke-color-picker" class="col-xs-9 input-group colorpicker-component">
                                                   <input id="polygon-stroke-color" type="text" value="#00AABB" class="form-control" aria-describedby="sizing-addon3"/>
                                                   <span class="input-group-addon"><i></i></span>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-stroke-with" class="col-xs-3 control-label">Ancho: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="polygon-stroke-with" type="text" value="1" class="form-control" aria-describedby="sizing-addon3"/>
                                               </div>
                                           </div>
                                           <div class="col-md-12 form-group form-group-sm">
                                               <label for="polygon-stroke-opacity" class="col-xs-3 control-label">Opacidad: </label>
                                               <div class="col-xs-9 input-group colorpicker-component">
                                                   <input id="polygon-stroke-opacity" class="form-control" data-slider-id='polygon-stroke-opacity' type="text" data-slider-min="0" data-slider-max="1" data-slider-step="0.02" data-slider-value="1"/>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>




                       </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick = "applyStyle()">Aceptar</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

</div>
</body>
</html>
