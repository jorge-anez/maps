<!DOCTYPE html>
<html lang="es">
<head>
    <title>OpenLayers.Editor</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="../lib/OpenLayers.js"></script>
    <script type="text/javascript" src="../lib/loader.js"></script>
    <script type="text/javascript" src="../jquery/jquery.js"></script>
    <script type="text/javascript" src="../bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../bootstrap/js/bootstrap-filestyle.min.js"></script>
    <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../bootstrap/css/bootstrap-theme.min.css" type="text/css" />
    <script type="text/javascript">
        var URL_SERVER = 'http://localhost';
		var map, editor;
        function init() {
            OpenLayers.Lang.setCode(language);
            map = new OpenLayers.Map('map');
           // map.addLayer(new OpenLayers.Layer.OSM());
            //async
            var baseLayerId = null;
            var BaseLayerRequest = new OpenLayers.Request.GET({
                url: URL_SERVER + '/gis-persistent/rest/project/0/layer/baseLayer',
                async: false,
                callback: function (response) {
                     var obj = JSON.parse(response.responseText);
                     baseLayerId = obj.data.layerId;
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });

			//console.log("after base layer");
			var boliviaLayer = new OpenLayers.Layer.Vector("Mapa Oruro", {
									projection       : "EPSG:4326",
                                    isBaseLayer      : true,
									strategies       : [new OpenLayers.Strategy.Fixed()],
									protocol         :  new OpenLayers.Protocol.HTTP({
                                                            url: URL_SERVER + '/gis-persistent/rest/project/0/layer/' + baseLayerId + '/listGeometries',
															format: new OpenLayers.Format.GeoJSON()
														}),
                                    styleMap: new OpenLayers.StyleMap({'default':{
                                                    strokeColor: "#00FF00",
                                                    strokeOpacity: 1,
                                                    strokeWidth: 2,
                                                    fillColor: "blue",
                                                    fillOpacity: 0.5,
                                                    pointRadius: 6,
                                                    pointerEvents: "visiblePainted",
                                                    // label with \n linebreaks
                                                    label : "${NAME_2}",

                                                    fontColor: "red",
                                                    fontSize: "11px",
                                                    fontFamily: "Courier New, monospace",
                                                    fontWeight: "bold",
                                                    labelAlign: "${align}",
                                                    labelXOffset: "${xOffset}",
                                                    labelYOffset: "${yOffset}",
                                                    labelOutlineColor: "white",
                                                    labelOutlineWidth: 2
                                    }})
								});
			map.addLayer(boliviaLayer);
            map.addControl(new OpenLayers.Control.MousePosition());
            map.addControl(new OpenLayers.Control.ScaleLine());
            map.addControl(new OpenLayers.Control.LayerSwitcher());
            //map.addControl(new OpenLayers.Control.KeyboardDefaults());
            //map.addControl(new OpenLayers.Control.OverviewMap());

            map.setCenter(new OpenLayers.LonLat(-67.79266, -18.70219), 1);


            editor = new OpenLayers.Editor(map, {
                activeControls: [
                      'LayerSettings'
                    , 'Navigation'
                    , 'SnappingSettings'
                    , 'CADTools'
                    , 'TransformFeature'
                    , 'Separator'
                    , 'DeleteFeature'
                    , 'DragFeature'
                    , 'SelectFeature'
                    , 'Separator'
                    , 'DrawHole'
                    , 'ModifyFeature'
                    , 'Separator'
                ],
                featureTypes: ['text','regular', 'polygon', 'path', 'point']
            });
            //editor.startEditMode();
            loadLayerList();
        }



        function uploadShape() {
            var formData = new FormData();
            formData.append("files", document.getElementById("shp").files[0]);
            formData.append("files", document.getElementById("dbf").files[0]);
            formData.append("files", document.getElementById("shx").files[0]);
            formData.append("files", document.getElementById("prj").files[0]);
            var request = new OpenLayers.Request.POST({
				url: URL_SERVER + '/gis-persistent/rest/file/temp/upload',
                data: formData,
                callback: function (response) {
                    console.log(response);
                   /*
                    var obj = JSON.parse(response.responseText);
                    var geojson  = new OpenLayers.Format.GeoJSON();
                    var jsonLayer = new OpenLayers.Layer.Vector();
                    map.addLayer(jsonLayer);
                    jsonLayer.addFeatures(geojson.read(obj));
                    */
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function loadLayerList() {
            var request = new OpenLayers.Request.GET({
                url:  URL_SERVER + '/gis-persistent/rest/project/1/layer/listAll',
                callback: function (response) {
                    var json = JSON.parse(response.responseText);
                    if(!json.success) {
                        alert('Error!!');
                        return;
                    }
                    var layerList = json.list;
                    var htmlStr = "";
                    layerList.forEach(function(e) {
                        htmlStr += "<tr>";
                        htmlStr += "<td>" + e.layerName + "</td>";
                        htmlStr += "<td><input type=\"checkbox\" checked onchange = \"setVisibility(" + e.layerId +", this.checked)\"></td>";
                        htmlStr += "<td><input type=\"radio\" name=\"editable\" onchange =\"addLayerToEditor(" + e.layerId + ")\"></td>";
                        htmlStr += "<td>";
                        htmlStr += "<div class=\"btn-group\" role=\"group\" aria-label=\"...\">";
                        htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\"  onclick = \"showAttributes(" + e.layerId + ")\"  data-toggle=\"tooltip\" title=\"Attributos\">";
                        htmlStr += "<span class=\"glyphicon glyphicon-eye-open\" aria-hidden=\"true\"></span>";
                        htmlStr += "</button>";
                        htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\"  onclick = \"guardarGeometria(" + e.layerId + ")\"  data-toggle=\"tooltip\" title=\"Guardar Geometria\">";
                        htmlStr += "<span class=\"glyphicon glyphicon-save\" aria-hidden=\"true\"></span>";
                        htmlStr += "</button>";
                        htmlStr += "<button type=\"button\" class=\"btn btn-default btn-sm\" data-toggle=\"tooltip\" title=\"Limpiar Geometria\">";
                        htmlStr += "<span class=\"glyphicon glyphicon-trash\" aria-hidden=\"true\"></span>";
                        htmlStr += "</button>";
                        htmlStr += "</div>";
                        htmlStr += "</td>";
                        htmlStr += "</tr>";
                        //var layer = new OpenLayers.Layer.Vector(e.layerName, {displayInLayerSwitcher: false});
                        //layer.id = e.layerId;
                        //map.addLayer(layer);
                        var layer = new OpenLayers.Layer.Vector("GeoJSON", {
                            displayInLayerSwitcher: false,
                            strategies: [new OpenLayers.Strategy.Fixed()],
                            protocol: new OpenLayers.Protocol.HTTP({
                                url: URL_SERVER + '/gis-persistent/rest/project/0/layer/' + e.layerId + '/listGeometries',
                                format: new OpenLayers.Format.GeoJSON()
                            })
                        });
                        layer.id = e.layerId;
                        map.addLayer(layer);
                    });
                    $('#layerList').html(htmlStr);
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function addLayerToEditor(layerId) {
            if(editor){
                editor.stopEditMode();
            }
            var layer = map.getLayer(layerId);
            if(!layer) {
                layer = new OpenLayers.Layer.Vector("GeoJSON", {
                    displayInLayerSwitcher: false
                });
                layer.id = layerId;
                map.addLayer(layer);
            }

            editor.editLayer = layer;
            //editor.stopEditMode();
            //editor.initialize(map, {editLayer: layer});
            //console.log(layer);
            editor.addEditorControls();
            editor.startEditMode();
            console.log(layer);
        }

        function setVisibility(layerId, state) {
            var layer = map.getLayer(layerId);
            if(layer)
                layer.setVisibility(state);
            else {
                layer = new OpenLayers.Layer.Vector("GeoJSON", {
                    displayInLayerSwitcher: false,
                    strategies: [new OpenLayers.Strategy.Fixed()],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: URL_SERVER + '/gis-persistent/rest/project/0/layer/' + layerId + '/listGeometries',
                        format: new OpenLayers.Format.GeoJSON()
                    })
                });
                layer.id = layerId;
                map.addLayer(layer);
            }
        }

        function guardarGeometria(layerId) {
            //console.log(layerId);

            var layer = map.getLayer(layerId);
            if(!layer.features.length){
                console.log('empty features');
                return
            }

            var formatJson = new OpenLayers.Format.GeoJSON();
            var geojson = JSON.parse(formatJson.write(map.getLayer(layerId).features));
            //console.log(geojson);
            var geojson = formatJson.write(map.getLayer(layerId).features);

            var request = new OpenLayers.Request.POST({
                url: URL_SERVER + '/gis-persistent/rest/project/1/layer/' + layerId + '/saveGeometries',
                data: geojson,
                dataType: 'json',
                callback: function (response) {
                    console.log(response);
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });

        }
        function addNewLayer() {
            $('#layerModal').modal('show');
        }
        function guardarCapa() {
            var layerName = $('#layerModal input').val();
            var obj = {
                layerName: layerName,
                epsgCode: 4326
            };
            var request = new OpenLayers.Request.POST({
                url: URL_SERVER + '/gis-persistent/rest/project/1/layer/save',
                data: JSON.stringify(obj),
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                dataType: 'json',
                callback: function (response) {
                    $('#layerModal').modal('hide');
                    $('#layerModal input').val('');
                    loadLayerList();
                    console.log(response);
                },
                failure: function (response) {
                    $('#layerModal').modal('hide');
                    console.log("Failure: ");
                    console.log(response);
                }
            });
        }

        function showAttributes(layerId) {
            var layer = map.getLayer(layerId);
            if(!layer) {
                layer = new OpenLayers.Layer.Vector("GeoJSON", {
                    displayInLayerSwitcher: false,
                    strategies: [new OpenLayers.Strategy.Fixed()],
                    protocol: new OpenLayers.Protocol.HTTP({
                        url: URL_SERVER + '/gis-persistent/rest/project/0/layer/' + layerId + '/listGeometries',
                        format: new OpenLayers.Format.GeoJSON()
                    })
                });
                layer.id = layerId;
                map.addLayer(layer);
            }
            var request = new OpenLayers.Request.GET({
                url: URL_SERVER + '/gis-persistent/rest/project/0/layer/' + layerId + '/listAttributes',
                callback: function (response) {
                    var obj = JSON.parse(response.responseText);
                    if(!obj.success) return;
                    var htmlHead = "<tr>";
                    obj.list.forEach(function(e) {
                        htmlHead += "<th>" + e.attributeName + "</th>";
                    });
                    htmlHead += "</tr>";

                    var htmlBody = "";
                    layer.features.forEach(function(feature) {
                        htmlBody += "<tr>";
                        obj.list.forEach(function(e) {
                            htmlBody += "<td>" + (feature.attributes['' + e.attributeName]) + "</td>";
                        });
                        htmlBody += "</tr>";
                    });

                    $('#attributeListModal table thead').html(htmlHead);
                    $('#attributeListModal table tbody').html(htmlBody);
                    $('#attributeListModal').modal('show');
                },
                failure: function (response) {
                    console.log("Failure: ");
                    console.log(response);
                }
            });

        }

    </script>
    <style type="text/css">
    /* Make map consume all available space */
    #map {
        height: 600px;
        min-height: 600px;
    }
    .btn-group {
        display: flex;
    }
    </style>
    <link rel="stylesheet" href="../theme/geosilk/geosilk.css" type="text/css" />
</head>
<body onload="init()">

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 panel panel-default">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#sectionA">Section A</a></li>
                <li><a data-toggle="tab" href="#sectionB">Section B</a></li>
                <li><a data-toggle="tab" href="#sectionC">Section C</a></li>
            </ul>
            <div class="tab-content">
                <div id="sectionA" class="tab-pane fade in active">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="text-center">Capas</th>
                                <th><div data-toggle="tooltip" title="Visible"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span></div></th>
                                <th><div data-toggle="tooltip" title="Editable"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></div></th>
                                <th class="text-center">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id = "layerList">
                                <tr>
                                    <td>Layer 1</td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="radio" name="editable"></td>
                                    <td>
                                        <div class="btn-group" role="group" aria-label="...">
                                            <button type="button" class="btn btn-default btn-sm">
                                                <span class="glyphicon glyphicon-save" aria-hidden="true"></span>
                                            </button>
                                            <button type="button" class="btn btn-default btn-sm">
                                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-default btn-sm" onclick="addNewLayer()">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Nueva Capa
                    </button>
                </div>
                <div id="sectionB" class="tab-pane fade table-responsive">
                    seccion B
                </div>
                <div id="sectionC" class="tab-pane fade">
                    <h3>Formato Shape File</h3>
                    <form id = "fileForm" method="post" action="" enctype="multipart/form-data">
                        <input id="shp" type="file" accept=".shp" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="dbf" type="file" accept=".dbf" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="shx" type="file" accept=".shx" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                        <input id="prj" type="file" accept=".prj" data-buttonText="Archivo" class="filestyle" data-buttonBefore="true">
                    </form>
                    <button onclick = "uploadShape()" class="btn btn-default">Subir</button>
                </div>
            </div>
        </div>


        <div class="col-sm-9 panel panel-default">
            <div id="map"></div>
        </div>
    </div>



    <div id="layerModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Nueva Capa</h4>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon" id="basic-addon1">Nombre o Desc.</span>
                        <input type="text" class="form-control" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCapa()">Guardar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->





    <div id="attributeModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Attributos</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Nombre Attributo</th>
                            <th>Tipo</th>
                            <th>Por Defecto</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>1</td>
                            <td>John</td>
                            <td>John</td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr>
                            <td><input type="text" size="5"></td>
                            <td><select></select></td>
                            <td><input type="text" size="5"></td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->




    <div id="attributeListModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Attributos</h4>
                </div>
                <div class="modal-body table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->





</div>
</body>
</html>
